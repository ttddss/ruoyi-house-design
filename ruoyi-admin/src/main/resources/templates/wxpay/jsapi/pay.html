<!DOCTYPE html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>支付跳转中</title>
</head>
<body>

</body>
<script th:src="${homeUrl}+'/js/jquery-3.3.1.min.js'" ></script>
<script th:src="${homeUrl}+'/js/vconsole.min.js'" ></script>
<script>
    // var vConsole = new VConsole();
</script>
<script type="text/javascript">
    var returnUrl = '[[${returnUrl}]]';
    var homeUrl = '[[${homeUrl}]]';
    var orderNo = '[[${orderNo}]]';
    if (returnUrl == '') {
        returnUrl = homeUrl + "/page/wxpay/jsapiSuccessFinal?orderNo=" + orderNo
    }

    // 发起微信支付
    if (typeof WeixinJSBridge == "undefined"){
        if( document.addEventListener ){
            document.addEventListener('WeixinJSBridgeReady', callPay, false);
        } else if (document.attachEvent){
            document.attachEvent('WeixinJSBridgeReady',callPay);
        }
    } else {
        callPay();
    }

    // 发起微信支付
    function callPay() {
        // 调用微信支付
        WeixinJSBridge.invoke('getBrandWCPayRequest', {
                "appId": '[[${payInfo.appId}]]',        //公众号ID，由商户传入
                "timeStamp": '[[${payInfo.timestamp}]]',        //时间戳，自1970年以来的秒数
                "nonceStr": '[[${payInfo.nonceStr}]]',       //随机串
                "package": '[[${payInfo.packageVal}]]',
                "signType": '[[${payInfo.signType}]]',       //微信签名方式：
                "paySign": '[[${payInfo.paySign}]]' //微信签名
            },
            function(res) {
                console.log("res:" + JSON.stringify(res));
                if (res.err_msg == "get_brand_wcpay_request:ok") {
                    // 使用以上方式判断前端返回,微信团队郑重提示：
                    //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                    setTimeout(function(){
                        window.location.href = returnUrl;
                    },1000)
                }
            }
        );
    }
</script>
</html>