<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.EvaluateMapper">
    
    <resultMap type="Evaluate" id="EvaluateResult">
        <result property="id"    column="id"    />
        <result property="score"    column="score"    />
        <result property="blueprintsId"    column="blueprints_id"    />
        <result property="orderNo"    column="order_no"    />
        <result property="userId"    column="user_id"    />
        <result property="imageUrl"    column="image_url"    />
        <result property="anonymous"    column="anonymous"    />
        <result property="content"    column="content"    />
        <result property="remark"    column="remark"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="delFlag"    column="del_flag"    />
    </resultMap>

    <sql id="selectEvaluateVo">
        select id, score, blueprints_id, order_no, user_id, image_url, anonymous, content, remark, create_by, create_time, update_by, update_time, del_flag from evaluate
    </sql>

    <select id="selectEvaluateList" parameterType="Evaluate" resultType="com.ruoyi.system.domain.vo.EvaluateListVO">
        select
            a.id,
            a.score,
            a.blueprints_id,
            a.order_no,
            a.user_id,
            a.image_url,
            a.anonymous,
            a.content,
            a.remark,
            a.create_by,
            a.create_time,
            a.update_by,
            a.update_time,
            a.del_flag ,
            a.create_by,
            a.create_time,
            a.update_by,
            a.update_time,
            b.nick_name,
            b.avatar,
            c.name as blueprintsName
        from evaluate a left join sys_user b on a.user_id = b.user_id
            left join blueprints c on c.id = a.blueprints_id
        <where>
            <if test="blueprintsId != null "> and a.blueprints_id = #{blueprintsId}</if>
            <if test="score != null "> and a.score = #{score}</if>
            <if test="minScore != null "> and a.score >= #{minScore}</if>
            <if test="maxScore != null "> and a.score &lt;= #{maxScore}</if>
            <if test="orderNo != null  and orderNo != ''"> and a.order_no = #{orderNo}</if>
            and a.del_flag = 0
        </where>
        <if test="orderWay != null">
            <choose>
                <when test="orderWay == 0">
                    order by a.id desc
                </when>
                <otherwise>
                    order by a.id desc
                </otherwise>
            </choose>
        </if>
        <if test="orderWay == null">
            order by a.id desc
        </if>

    </select>
    
    <select id="evaluateStatics" resultType="com.ruoyi.system.domain.dto.EvaluateScoreStaticsDTO">
        select
            score, count(1) as num
        from evaluate
        where blueprints_id = #{blueprintsId} and del_flag = 0
        group by score
    </select>
</mapper>